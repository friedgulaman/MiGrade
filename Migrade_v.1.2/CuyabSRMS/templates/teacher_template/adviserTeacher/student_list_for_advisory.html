{% extends 'teacher_template/adviserTeacher/adviser_teacher_base.html' %}
{% load static %}
{% block title %}
Student List for {{ grade }} {{ section }} {{ class_type}}
{% endblock title %}

{% block main_content %}
<style>
    .folder-icon {
        color: #1F3BB3;
    }

    .student-icon {
        font-size: 16px;
    }

    .students-tab {
        height: 90vh;
        overflow-y: hidden;
    }

    .students-tab:hover {
        overflow-y: auto;
    }

    .students-tab::-webkit-scrollbar {
        width: 10px;
        /* For Chrome, Safari, and Opera */
        display: none;
        /* Hide the scrollbar by default */
    }

    .students-tab:hover::-webkit-scrollbar {
        display: block;
        /* Show the scrollbar on hover */
    }

    .students-tab::-webkit-scrollbar-thumb {
        background-color: #ccc;
        /* For Chrome, Safari, and Opera */
    }

    .students-tab::-webkit-scrollbar-track {
        background-color: #f5f5f5;
        /* For Chrome, Safari, and Opera */
    }
    .view{
        cursor: pointer;
    }
    .back-button {
        color: #1027ac;
        font-size: 30px;
        text-decoration: none;
        cursor: pointer;
    }

    .record_id {
        text-decoration: none;
        cursor: pointer;
        color: #1027ac;
    }

    .delete-record {
        text-decoration: none;
        cursor: pointer;
        color: red;
        border: none;
        background: none;
        transition: color 0.3s;
        /* Smooth color transition */

        /* Shake animation on hover */
        position: relative;
    }

    .delete-record:hover {
        color: darkred;
        /* Change color on hover */
        animation: shake 0.5s;
    }

    /* Define the shake animation */
    @keyframes shake {
        0% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        50% {
            transform: translateX(5px);
        }

        75% {
            transform: translateX(-5px);
        }

        100% {
            transform: translateX(0);
        }
    }
</style>
<section class="content container mt-2 ">
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center p-4">
                    <a href="{% url 'display_students' %}">
                        <i class="fas fa-folder fa-4x me-3 folder-icon"></i>
                    </a>
                    <div class="ms-2">
                        <h4 class="display-5 fw-bold"> {{ grade }} ({{ section }}) <code
                                class="text-muted">{{ class_type }}</code></h4>
                        <p class="d-flex align-content-center text-muted"><i
                                class="mdi mdi-account me-1 student-icon "></i>{{ students|length }} students</p>
                    </div>
                </div>
                <div class=" me-4">
                    <a class="back-button">&larr;</a>
                </div>
            </div>
            <section class="content container mt-2 vh-100">
                <div class="d-sm-flex align-items-center justify-content-between border-bottom">
                    <ul class="nav nav-tabs text" role="tablist">
                        <li class="nav-item ">
                            <a class="nav-link active " id="home-tab" data-bs-toggle="tab" href="#students" role="tab"
                                aria-controls="students" aria-selected="true">Students</a>
                        </li>
                        <li class="nav-item ">
                            <a class="nav-link" id="profile-tab" data-bs-toggle="tab" href="#classrecord" role="tab"
                                aria-selected="false">Final Grade per Subject</a>
                        </li>
                        <li class="nav-item ">
                            <a class="nav-link" id="contact-tab" data-bs-toggle="tab" href="#quarterly" role="tab"
                                aria-selected="false">Summary of Quarterly Grades</a>
                        </li>
                        <li class="nav-item ">
                            <a class="nav-link" id="more-tab" data-bs-toggle="tab" href="#rankings" role="tab"
                                aria-selected="false">Rankings</a>
                        </li>
                    </ul>
                </div>

                <div class="tab-content tab-content-basic students-tab ">
                    <div class="tab-pane fade show active" id="students" role="tabpanel" aria-labelledby="overview">
                        <div class="container mt-4">
                            <div class="grid-margin stretch-card">
                                <div>
                                    <div class="card-body">
                                        <h4 class="card-title">Students</h4>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th></th>
                                                        <th>LRN</th>
                                                        <th>Learners Name</th>
                                                        <th>Sex</th>
                                                        <th>Birthday</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for student in students %}
                                                    <tr>
                                                        <td>
                                                            {{ forloop.counter }}
                                                        </td>
                                                        <td>
                                                            {{ student.lrn }}
                                                        </td>
                                                        <td>
                                                            {{ student.name }}
                                                        </td>
                                                        <td>
                                                            {{ student.sex }}
                                                        </td>
                                                        <td>
                                                            {{ student.birthday }}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="classrecord" role="tabpanel" aria-labelledby="classrecord">

                        <div class="container mt-4">
                            <div class="grid-margin stretch-card">
                                <div>
                                   
                                    <div class="card-body">
                                        <h4 class="card-title">Subject Grades</h4>
                                        <p id="grade" style="display: none;">{{ grade }}</p>
                                        <p id="section" style="display: none;">{{ section }}</p>
                                        <div class="table-responsive ">
                                            <table class="table table-hover text-center ">
                                                <thead class="text-center">
                                                    <tr>
                                                        <th>Subject</th>
                                                        <th>Subject Teacher</th>
                                                        <th></th>
                                                    </tr>
                                                    {% load custom_filters %}
                                                    <tbody class="text-muted">
                                                        {% if unique_keys %}
                                                            {% for key, from_teacher_id in unique_keys %}
                                                                <tr onclick="showQuarters('{{ grade }}', '{{ section }}', '{{ key }}', '{{ from_teacher_id }}')">
                                                                    <td>{{ key }}</td>
                                                                    <td>{{ from_teacher_id }}</td>
                                                                    <td class="text-muted view">View Details</td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="3">No class records found.</td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                    
                                                    
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Add this modal markup at the end of your template -->

  
                    </div>

                        
                    <div class="tab-pane fade show" id="quarterly" role="tabpanel" aria-labelledby="subjects">
                        <div class="container mt-4">
                            <div class="grid-margin stretch-card">
                                <div>
                                    <div class="card-body">
                                        <form id="quarterForm" method="get">
                                            <!-- Hidden input fields for grade, section, and class_type -->
                                            <input type="hidden" name="grade" value="{{ grade }}">
                                            <input type="hidden" name="section" value="{{ section }}">
                                            <input type="hidden" name="class_type" value="{{ class_type }}">
                                        
                                            <!-- Select dropdown for the quarter -->
                                            <select name="quarter" onchange="submitFormAndRememberScroll()">
                                                <option value="1st Quarter" {% if quarter == '1st Quarter' %} selected {% endif %}>1st Quarter</option>
                                                <option value="2nd Quarter" {% if quarter == '2nd Quarter' %} selected {% endif %}>2nd Quarter</option>
                                                <option value="3rd Quarter" {% if quarter == '3rd Quarter' %} selected {% endif %}>3rd Quarter</option>
                                                <option value="4th Quarter" {% if quarter == '4th Quarter' %} selected {% endif %}>4th Quarter</option>
                                            </select>
                                        </form>
                                        <h4 class="card-title mt-4">Summary of Quarterly Grades ({{quarter}})</h4>
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>No.</th>
                                                    <th>Student Name</th>
                                                    {% for subject_data in data.0.subjects_data %}
                                                        <th>{{ subject_data.subject }}</th>
                                                    {% endfor %}
                                                    <th>Average Score</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in data %}
                                                    <tr>
                                                        <td>{{ item.no }}</td>
                                                        <td>{{ item.student_name }}</td>
                                                            {% for subject_data in item.subjects_data %}
                                                                <td>{{ subject_data.score|default_if_none:""}}</td>
                                                            {% endfor %}

                                                        <td>{{ item.average_score|default_if_none:"" }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade show" id="rankings" role="tabpanel" aria-labelledby="rankings">
                        <div class="container mt-4">
                            <!-- Dropdown menu for selecting the subject -->
                            <div class="mb-3">
                                <label for="subjectSelect" class="form-label">Select Subject:</label>
                                <select class="form-select" id="subjectSelect" onchange="filterStudents(this.value)">
                                    <option value="">Select a Subject</option>
                                    <!-- Iterate over each subject -->
                                    {% for subject in top_10_students_per_subject.keys %}
                                        <option value="{{ subject }}">{{ subject }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="grid-margin stretch-card">
                                <div>
                                    <div class="card-body">
                                        <h4 class="card-title">Top 10 Students per Subject</h4>
                                        <!-- Iterate over each subject -->
                                        {% for subject, students in top_10_students_per_subject.items %}
                                            <div class="mb-4" id="{{ subject }}">
                                                <h5>{{ subject }}</h5>
                                                <div class="table-responsive">
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>Rank</th>
                                                                <th>Student Name</th>
                                                                <th>Final Grade</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <!-- Iterate over the top 10 students for the current subject -->
                                                            {% for student, final_grade in students %}
                                                                <tr>
                                                                    <td>{{ forloop.counter }}</td>
                                                                    <td>{{ student }}</td>
                                                                    <td>{{ final_grade }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

            </section>
        </div>
    </div>
</section>
<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    function filterStudents(subject) {
        // Hide all subject tables
        document.querySelectorAll('.mb-4').forEach(function(table) {
            table.style.display = 'none';
        });


        // Show the selected subject table
        if (subject) {
            document.getElementById(subject).style.display = 'block';
        }
    }
</script>

<script>
    function submitFormAndRememberScroll() {
        // Store the current scroll position in session storage
        sessionStorage.setItem('scrollPosition', window.scrollY);

        // Submit the form
        document.getElementById('quarterForm').submit();
    }

    // Restore scroll position when the page loads
    window.onload = function() {
        var scrollPosition = sessionStorage.getItem('scrollPosition');
        if (scrollPosition !== null) {
            window.scrollTo(0, scrollPosition);
            sessionStorage.removeItem('scrollPosition'); // Remove stored scroll position
        }

        // Check if there is a query parameter for the quarter in the URL
        const urlParams = new URLSearchParams(window.location.search);
        const quarter = urlParams.get('quarter');
        if (quarter !== null) {
            // Activate the #quarterly tab
            $('a[href="#quarterly"]').tab('show');
        }
    };
</script>
<script>
    var showQuarters = function(grade, section, key, from_teacher_id){

    var url = "{% url 'display_advisory_data' %}?grade=" + encodeURIComponent(grade) + "&section=" + encodeURIComponent(section) + "&key=" + encodeURIComponent(key) + "&from_teacher_id=" + encodeURIComponent(from_teacher_id);
    window.location.href = url;
    };
    
 
    // JavaScript to handle the back button click event
    document.querySelector(".back-button").addEventListener("click", function () {
        window.history.back();
    });

    $(document).ready(function () {


        $('.delete-record').click(function () {
            var recordId = $(this).data('record-id');

            // Confirm deletion (you may customize this part)
            if (confirm('Are you sure you want to delete this record?')) {
                $.ajax({
                    url: '{% url "delete_classrecord" class_record_id=999 %}'.replace('999', recordId),
                    type: 'post',
                    data: $('#deleteForm_' + recordId).serialize(),
                    success: function () {
                        // Update the content or redirect to the last URL as needed
                        location.reload();  // Reload the page, you may replace this with more specific updates
                    },
                    error: function () {
                        alert('An error occurred while deleting the record.');
                    }
                });
            }
        });
    });
</script>

{% endblock main_content %}