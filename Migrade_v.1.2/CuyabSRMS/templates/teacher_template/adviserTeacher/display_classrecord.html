{% extends 'teacher_template/teacher_base.html' %}
{% block page_title %}
    Adviser Teacher
{% endblock page_title %}
{% block main_content %}
<style>
    .table, th {
        border: solid 2px;
    }
    td {
        border: solid 2px;
    }

    #components {
        color: red;
        text-align: center;
    }
    .table-responsive {
        width: 100%; /* Adjust the width as needed */
        margin: 0 auto; /* Center the table within its container */
    }

    .table {
        width: 100%; /* Make the table fill the available width */
    }

    .back-button {
    color: #1027ac;
    font-size: 30px;
    text-decoration: none;
    cursor: pointer;
  }
    
</style>
<section class="content container mt-2">
      <div class="mt-5 border-bottom">
        <div class="card-body ">
            <div class="d-flex justify-content-between align-items-center m-2 p-3 ">
          <h3 >Class Record Information</h3>
          <a class="back-button ">&larr;</a>
          </div>
          <div class="row text-primary d-flex justify-content-between align-items-center text-center">
            <div class="col">
              <p class="card-text "><strong class="text-muted">Grade:</strong> {{ class_record.grade }}</p>
            </div>
            <div class="col">
              <p class="card-text"><strong class="text-muted">Section:</strong> {{ class_record.section }}</p>
            </div>
            <div class="col">
              <p class="card-text"><strong class="text-muted">Subject:</strong> {{ class_record.subject }}</p>
            </div>
            <div class="col">
              <p class="card-text"><strong class="text-muted">Quarters:</strong> {{ class_record.quarters }}</p>
            </div>
            <!-- <div class="col">
                <p class="card-text"><strong class="text-muted">Class Record Id:</strong> {{ class_record.id }}</p>
                <input type="hidden" name="class_record_id" value="{{ class_record.id }}">
              </div> -->
              <input type="hidden" name="class_record_id" value="{{ class_record.id }}">
          </div>
        </div>
      </div>
      <div class="d-sm-flex align-items-center justify-content-between border-bottom">
        <ul class="nav nav-tabs" role="tablist" id="assessmentTabs">
        </ul>
        <div>
            <div class="d-flex justify-content-end align-items-end">
                <button id="submitButton" type="submit" class="btn btn-primary p-2 m-2">Save</button>
            </div>
        </div>
    </div>
    
    <div class="tab-content tab-content-basic" id="assessmentTabContent">
            <!-- Add the default tab for Initial Grade -->
        <!-- Initial Grades -->
        <div class="tab-pane fade show" id="initial_grade" role="tabpanel" aria-labelledby="more-tab">
            <div class="mb-3">
                {% if gradescores %}
                <div class="table-responsive">
                    <div id="components">INITIAL GRADE</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Name</th>
                                <th>Initial Grade</th>
                                <th>Quarterly Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr></tr>
                            <tr>
                                <th></th>
                                <th>MALE</th>
                                <th></th>
                                <th></th>
                                
                            </tr>
                            {% for record in gradescores %}
                                {% if record.student.sex == 'M' %}
                                    <tr class="male-row">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ record.student.name }}</td>
                                        <td id="total_initial_grade" name="total_initial_grade"> {% if record.initial_grades is not None %}{{ record.initial_grades }}{% else %}{{ "" }}{% endif %}</td>
                                        <td> {% if record.transmuted_grades is not None %}{{ record.transmuted_grades }}{% else %}{{ "" }}{% endif %}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            <tr></tr>
                            <tr>
                                <th></th>
                                <th>FEMALE</th>
                                <th></th>
                                <th></th>
                            </tr>
                            {% for record in gradescores %}
                                {% if record.student.sex == 'F' %}
                                    <tr class="female-row">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ record.student.name }}</td>
                                        <td id="total_initial_grade" name="total_initial_grade"> {% if record.initial_grades is not None %}{{ record.initial_grades }}{% else %}{{ "" }}{% endif %}</td>
                                        <td> {% if record.transmuted_grades is not None %}{{ record.transmuted_grades }}{% else %}{{ "" }}{% endif %}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div> 
</div>
</section>



<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    $(document).ready(function () {
        // Get the assessment types from the backend or any other source
        var assessmentTypes = "{{ assessment_types|safe }}".replace(/[\[\]"']/g, "").split(',').map(function(item) {
            return item.trim();
        });
       

        // console.log(assessmentTypeProcessed)

        var assessmentValues = "{{ assessment_values|safe }}".replace(/[\[\]"]/g, "").split(',').map(function(item) {
            return item.trim();
        });

        // var keys = "{{processed_types|safe}}".replace(/[\[\]'""]/g, "").split(',').map(function(item) {
        //     return item.trim();
        // });

        // console.log(keys)

        var classRecordIdValue = $('input[name="class_record_id"]').val();
        // Loop through each assessment type
        assessmentTypes.forEach(function (assessmentType, index) {
            
            var value = assessmentValues[index]; 
            // console.log("value:" + value)
            var assessmentTypeProcessed = assessmentType.replace(/\s+/g, '-').toLowerCase();
            console.log(assessmentTypeProcessed)

            
             $.ajax({
                url: '/process_assessment_type/',
                type: 'POST',
                data: {
                    assessmentTypeProcessed: assessmentTypeProcessed,
                    class_record_id: classRecordIdValue,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    // Handle success response from the server if needed
                    console.log("Assessment type processed sent successfully. " + assessmentTypeProcessed);
                    
                    // Update HTML content based on received date
                },
                error: function(xhr, status, error) {
                    // Handle error response if needed
                    console.error('Error sending assessment type processed:', error);
                    // Call any function or perform any action you need upon error
                    // For example:
                    // handleErrorResponse(xhr, status, error);
                }
            });

            // var key = keys[index].replace(/\s+/g, '-').toLowerCase();
            // console.log("key:" + key)

                
            // Create a new list item for the assessment tab
            var listItem = $('<li class="nav-item"></li>');
            // Create a new anchor tag for the assessment tab
            var anchorTag = $('<a class="nav-link" role="tab" aria-selected="false"></a>')
                .attr('id', 'assessment-tab-' + index)
                .attr('data-bs-toggle', 'tab')
                .attr('href', '#assessment-' + index)
                .text(assessmentType);

            // Append the anchor tag to the list item
            listItem.append(anchorTag);

            // Append the list item to the navigation tabs
            $('#assessmentTabs').append(listItem);

            // Create a new tab-pane for the assessment content
            var tabPane = $('<div class="tab-pane fade show"></div>')
                .attr('id', 'assessment-' + index)
                .attr('role', 'tabpanel')
                .append('<div class="mb-3">' +
                            '<div class="table-responsive">' +
                                '<div id="components">' + assessmentType + '</div>' +
                                '<table class="table">' +
                                    '<thead>' +
                                        '<tr>' +
                                            '<th></th>' +
                                            '<th>Name</th>' +
                                            '<th>{{assessment_type_processed}}</th>' +
                                            '<th>2</th>' +
                                            '<th>3</th>' +
                                            '<th>4</th>' +
                                            '<th>5</th>' +
                                            '<th>6</th>' +
                                            '<th>7</th>' +
                                            '<th>8</th>' +
                                            '<th>9</th>' +
                                            '<th>10</th>' +
                                            '<th>Total</th>' +
                                            '<th>PS</th>' +
                                            '<th>WS</th>' +
                                        '</tr>' +
                                       
                                        '<tr>' +
                                            '<td></td>' +      
                                            '<th>Highest possible scores</th>' +
                                            '{% for key, value in gradescores.0.grade_scores.scores_hps.items %}'+
                                            '{% if key == assessment_type_processed.0 %}' +
                                            '{% for score in value %}'+
                                            '<td class="highest-possible-scores" contenteditable="true">{{ score }}</td>' +
                                            '{% endfor %}'+
                                            '{% endif %}' +
                                            '{% endfor %}'+

                                            '<td id="total_max_' +assessmentTypeProcessed + '" name="total_max_' + assessmentTypeProcessed+ '">Total</td>' +
                                            '<td>100.00</td>' +
                                            '<td id="weight_' + assessmentTypeProcessed + '" name="weight_' + assessmentTypeProcessed + '" value="' + value + '">' + value + '</td>' +
                                        '</tr>' +
                                       
                                    '</thead>' +
                                    '<tbody>' +
                                        '<tr></tr>' +
                                        '<tr>' +
                                            '<th></th>' +
                                            '<th>MALE</th>' +
                                            '{% load custom_filters %}' +
                                            '{% for i in 1|th %}' +
                                                '<th></th>' +
                                            '{% endfor %}' +
                                        '</tr>' +
                                        '{% for record in gradescores %}' +
                                            '{% if record.student.sex == "M" %}' +
                                                '<tr class="male-row">' +
                                                    '<td>{{ forloop.counter }}</td>' +
                                                    '<td>{{ record.student.name }}</td>' +
                                                    '{% for score in record.grade_scores %}' +
                                                    '<td class="score-cell" contenteditable="true">{{ score }}</td>' +
                                                    '{% endfor %}' +
                                                   
                                                '</tr>' +
                                            '{% endif %}' +
                                        '{% endfor %}' +
                                        '<tr></tr>' +
                                        '<tr>' +
                                            '<th></th>' +
                                            '<th>FEMALE</th>' +
                                            '{% load custom_filters %}' +
                                            '{% for i in 1|th %}' +
                                                '<th></th>' +
                                            '{% endfor %}' +
                                        '</tr>' +
                                        '{% for record in gradescores %}' +
                                            '{% if record.student.sex == "F" %}' +
                                                '<tr class="female-row">' +
                                                    '<td>{{ forloop.counter }}</td>' +
                                                    '<td>{{ record.student.name }}</td>' +
                                                    '{% for score in record.grade_scores %}' +
                                                    '<td class="score-cell" contenteditable="true">{{ score }}</td>' +
                                                    '{% endfor %}' +
                                                   
                                            '</tr>' +
                                            '{% endif %}' +
                                        '{% endfor %}' +
                                    '</tbody>' +
                                '</table>' +
                            '</div>' +
                        '</div>');

            // Append the tab-pane to the tab-content
            $('.tab-content.tab-content-basic').append(tabPane);

        });
       
        $('#assessmentTabs').append('<li class="nav-item"><a class="nav-link" id="initial-grade-tab" data-bs-toggle="tab" href="#initial_grade" role="tab" aria-selected="false">INITIAL GRADES</a></li>');

        // Simulate a click on the first assessment tab
        $('#assessmentTabs li:first-child a').tab('show');

    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if the page was reloaded after clicking the "Initial Grade" tab
      var activeSection = localStorage.getItem('activeSection');
  
      // If the page was reloaded and the active section is "Initial Grade," set it as active
      if (activeSection === 'initial_grade') {
        var initialGradeTab = document.querySelector('[href="#initial_grade"]');
        if (initialGradeTab) {
          initialGradeTab.click();
        }
      }
  
      // Add an event listener to the "Initial Grade" tab
      var initialGradeTab = document.querySelector('[href="#initial_grade"]');
      if (initialGradeTab) {
        initialGradeTab.addEventListener('click', function() {
          // Store the active section in local storage
          localStorage.setItem('activeSection', 'initial_grade');
  
          // Reload the page when the "Initial Grade" tab is clicked
          location.reload(true);
        });
      }
    });
  </script>

<script>
    // JavaScript to handle going back two steps in the browsing history
    document.addEventListener("DOMContentLoaded", function() {
       // Check if the browser supports the history API
       if (window.history && window.history.back) {
           // Go back two steps in the browsing history when the back button is clicked
           document.querySelector(".back-button").addEventListener("click", function () {
               window.history.back();

           });
       }
    });
   </script>
<script>


    // Add an event listener for the arrow keys in quarterly assessment
$('.table tbody tr td[contenteditable="true"]').keydown(function (e) {
    var currentCell = $(this);
    var currentRow = currentCell.closest('tr');
    var currentColumnIndex = currentCell.index();

    switch (e.which) {

        case 38: // Up arrow
            e.preventDefault();
            navigateUp(currentRow, currentColumnIndex);
            break;

        case 40: // Down arrow
            e.preventDefault();
            navigateDown(currentRow, currentColumnIndex);
            break;

        default:
            return; // Exit if not an arrow key
    }
});

function navigateUp(row, columnIndex) {
    var prevRow = row.prev('tr');
    if (prevRow.length > 0) {
        prevRow.find('td:eq(' + columnIndex + ')').focus();
    }
}

function navigateDown(row, columnIndex) {
    var nextRow = row.next('tr');
    if (nextRow.length > 0) {
        nextRow.find('td:eq(' + columnIndex + ')').focus();
    }
}
$('.score-cell[contenteditable="true"]').keydown(function(e) {
    var currentCell = $(this);
    var currentRow = currentCell.closest('tr');
    var currentColumnIndex = currentCell.index();

    switch (e.which) {
        case 37: // Left arrow
            e.preventDefault();
            navigateLeft(currentRow, currentColumnIndex);
            break;

        case 39: // Right arrow
            e.preventDefault();
            navigateRight(currentRow, currentColumnIndex);
            break;

        case 38: // Up arrow
            e.preventDefault();
            navigateUp(currentRow, currentColumnIndex);
            break;

        case 40: // Down arrow
            e.preventDefault();
            navigateDown(currentRow, currentColumnIndex);
            break;

        default:
            return; // Exit if not an arrow key
    }
});

function navigateLeft(row, columnIndex) {
    if (columnIndex > 2) {
        row.find('td:eq(' + (columnIndex - 1) + ')').focus();
    }
}

function navigateRight(row, columnIndex) {
    if (columnIndex < 13) {
        row.find('td:eq(' + (columnIndex + 1) + ')').focus();
    }
}

function navigateUp(row, columnIndex) {
    var prevRow = row.prev('tr');
    if (prevRow.length > 0) {
        prevRow.find('td:eq(' + columnIndex + ')').focus();
    }
}

function navigateDown(row, columnIndex) {
    var nextRow = row.next('tr');
    if (nextRow.length > 0) {
        nextRow.find('td:eq(' + columnIndex + ')').focus();
    }
}

// Add an event listener for the arrow keys in highest possible scores
$('.highest-possible-scores[contenteditable="true"]').keydown(function(e) {
    var currentCell = $(this);
    var currentRow = currentCell.closest('tr');
    var currentColumnIndex = currentCell.index();

    switch (e.which) {
        case 37: // Left arrow
            e.preventDefault();
            navigateLeftHPS(currentRow, currentColumnIndex);
            break;

        case 39: // Right arrow
            e.preventDefault();
            navigateRightHPS(currentRow, currentColumnIndex);
            break;

        case 38: // Up arrow
            e.preventDefault();
            navigateUpHPS(currentRow, currentColumnIndex);
            break;

        case 40: // Down arrow
            e.preventDefault();
            navigateDownHPS(currentRow, currentColumnIndex);
            break;

        default:
            return; // Exit if not an arrow key
    }
});

function navigateLeftHPS(row, columnIndex) {
    if (columnIndex > 2) {
        row.find('td.highest-possible-scores:eq(' + (columnIndex - 3) + ')').focus();
    }
}

function navigateRightHPS(row, columnIndex) {
    if (columnIndex < 13) {
        row.find('td.highest-possible-scores:eq(' + (columnIndex - 1 ) + ')').focus();
    }
}

function navigateUpHPS(row, columnIndex) {
    var prevRow = row.prev('tr');
    if (prevRow.length > 0) {
        prevRow.find('td.highest-possible-scores:eq(' + columnIndex + ')').focus();
    }
}

function navigateDownHPS(row, columnIndex) {
    var nextRow = row.next('tr');
    if (nextRow.length > 0) {
        nextRow.find('td.highest-possible-scores:eq(' + columnIndex + ')').focus();
    }
}

$(document).ready(function () {


    function updateTotalMaxWrittenWorks() {
            var totalMaxWrittenWorks = 0;
            $('#written_works .highest-possible-scores[contenteditable="true"]').each(function () {
                var score = parseFloat($(this).text()) || 0;
                totalMaxWrittenWorks += score;
            });
    
    
            $('#total_max_written_works').text(totalMaxWrittenWorks.toFixed(2));
        }
    
    
        function updateTotalMaxPerformance() {
            var totalMaxPerformance = 0;
            $('#performance_task .highest-possible-scores[contenteditable="true"]').each(function () {
                var score = parseFloat($(this).text()) || 0;
                totalMaxPerformance += score;
            });
    
    
            $('#total_max_performance_task').text(totalMaxPerformance.toFixed(2));
        }
    
    
        // function updateTotalQuarterly() {
        //     var totalMaxQuarterly = 0;
        //     $('#quarterly_assessment .highest-possible-scores[contenteditable="true"]').each(function () {
        //         var score = parseFloat($(this).text()) || 0;
        //         totalMaxQuarterly += score;
        //     });
    
    
        //     $('#total_max_quarterly').text(totalMaxQuarterly.toFixed(2));
        // }
        updateTotalMaxWrittenWorks();
        updateTotalMaxPerformance();
        // updateTotalQuarterly();

    $(document).ready(function() {
    // Retrieve the stored section ID from local storage
    var storedSectionId = localStorage.getItem('activeSection');

    // If a section ID is found, set the corresponding tab as active
    if (storedSectionId) {
        $('.nav-tabs a[href="#' + storedSectionId + '"]').tab('show');
    }

    // Clear the stored section ID after using it
    localStorage.removeItem('activeSection');
    });

    // Add an event listener for the contenteditable cells
    $('.score-cell[contenteditable="true"]').blur(function () {
        // Get the updated score, column index, and section identifier
        var newScore = $(this).text();

        if (newScore.trim() === '') {
        return;  // Do not update if the input is empty
        }
        var columnIndex = $(this).index() -2 ;  // Adjust to 0-based indexing
        var sectionId = $(this).closest('.tab-pane').attr('id');

        // Get the row, student name, and the corresponding cells
        var row = $(this).closest('tr');
        var studentName = row.find('td:eq(1)').text();
        var totalScoreCell, percentageScoreCell, weightedScoreCell, total_initial_grade_cell;



        // Determine the corresponding cells based on the section identifier
        if (sectionId === 'written_works' || sectionId === 'performance_task') {
            totalScoreCell = row.find('td:eq(12)'); // Use the class to select all total-score cells
            percentageScoreCell = row.find('td:eq(13)');
            weightedScoreCell = row.find('td:eq(14)');
        } else if (sectionId === 'quarterly_assessment'){
            totalScoreCell = row.find('td:eq(2)'); // Use the class to select all total-score cells
            percentageScoreCell = row.find('td:eq(3)');
            weightedScoreCell = row.find('td:eq(4)');
        } else {
            return;  // Invalid section identifier
        }

        var classRecordId = $('input[name="class_record_id"]').val();
        var scoresHpsData = [];
        var totalScoreValue = totalScoreCell.text();

        var total_max_written_works =  parseFloat($('#total_max_written_works').text());
        var written_works_weight = parseFloat($('#written_works_weight').text());

        var total_max_performance_task = parseFloat($('#total_max_performance_task').text());
        var performance_task_weight = parseFloat($('#performance_task_weight').text());

        var total_max_quarterly = parseFloat($('#total_max_quarterly').text());
        var quarterly_assessment_weight = parseFloat($('#quarterly_assessment_weight').text());


        console.log(totalScoreValue);

        // Get the Highest Possible Scores data from the table
        row.find('td[contenteditable="true"]').each(function () {
            scoresHpsData.push($(this).text());
        });

        // Send an AJAX request to update the score
        $.ajax({
            type: "POST",
            url: "/update_score/",
            data: {
                'class_record_id': classRecordId,
                'student_name': studentName,
                'new_score': newScore,
                'column_index': columnIndex,
                'section_id': sectionId,
                'scores_hps': scoresHpsData,
                'total_score_value': totalScoreValue,
                'total_max_written_works': total_max_written_works,
                'written_works_weight': written_works_weight,
                'total_max_performance_task': total_max_performance_task,
                'performance_task_weight': performance_task_weight,
                'total_max_quarterly': total_max_quarterly,
                'quarterly_assessment_weight': quarterly_assessment_weight,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (data) {

                if (data.success === false) {
                    alert(data.error);

                    // Get the section ID dynamically based on the active section
                    var sectionId = $('.tab-pane.active').attr('id');

                    // If the sectionId is undefined, you may need to adjust this based on your HTML structure
                    if (!sectionId) {
                        console.error('Unable to determine the active section ID.');
                        return;
                    }

                    // Store the section ID in local storage
                    localStorage.setItem('activeSection', sectionId);

                    // Reload the page with the fragment identifier
                    location.reload(true);
                } else {
                
                // Update the specific cells based on the column index and section identifier
                if (columnIndex >= 0 && columnIndex <= 9) {
                    totalScoreCell.text(data.total_score);
                    percentageScoreCell.text(data.percentage_score);
                    weightedScoreCell.text(data.weighted_score);

                    // Calculate and update the total initial grade
                    var updatedWeightedScoreWritten = parseFloat($('#weighted_score_max_written_works').text()) || 0;
                    var updatedWeightedScorePerformance = parseFloat($('#weighted_score_performance_task').text()) || 0;
                    var updatedWeightedScoreQuarterly = parseFloat($('#weighted_score_quarterly_assessment').text()) || 0;

                    var totalWeightedScore = updatedWeightedScoreWritten + updatedWeightedScorePerformance + updatedWeightedScoreQuarterly;
                    $('#total_initial_grade').text(totalWeightedScore.toFixed(2));

                    if (sectionId === 'written_works') {
                        // Calculate the percentage score for written works
                        var totalMaxWrittenWorks = parseFloat($('#total_max_written_works').text());
                        var percentageWrittenWorks = (data.total_score / totalMaxWrittenWorks) * 100;
                        var writtenWorksWeight = parseFloat($('#written_works_weight').text());
                        var updatedWeightedScoreWritten = (percentageWrittenWorks / 100) * writtenWorksWeight;
                     
                        // Update the percentage and weighted score cells for written works
                        percentageScoreCell.text(percentageWrittenWorks.toFixed(2));
                        weightedScoreCell.text(updatedWeightedScoreWritten.toFixed(2));
                    } else if (sectionId === 'performance_task') {
                        // Calculate the percentage score for performance task
                        var totalMaxPerformanceTask = parseFloat($('#total_max_performance_task').text());
                        var percentagePerformanceTask = (data.total_score / totalMaxPerformanceTask) * 100;
                        var performanceTaskWeight = parseFloat($('#performance_task_weight').text());
                        var updatedWeightedScorePerformance = (percentagePerformanceTask / 100) * performanceTaskWeight;

                        // Update the percentage and weighted score cells for performance task
                        percentageScoreCell.text(percentagePerformanceTask.toFixed(2));
                        weightedScoreCell.text(updatedWeightedScorePerformance.toFixed(2));
                    } else if (sectionId === 'quarterly_assessment') {
                        
                        var totalMaxQuarterly = parseFloat($('#total_max_quarterly').text());
                        var percentageQuarterly = (data.total_score / totalMaxQuarterly) * 100;
                        var quarterlyAssessmentWeight = parseFloat($('#quarterly_assessment_weight').text());
                        var updatedWeightedScoreQuarterly = (percentageQuarterly / 100) * quarterlyAssessmentWeight;

                        // Update the percentage and weighted score cells for quarterly assessment
                        percentageScoreCell.text(percentageQuarterly.toFixed(2));
                        weightedScoreCell.text(updatedWeightedScoreQuarterly.toFixed(2));
                    }
                    
                console.log('Update Score Success:', data);
                console.log('Initial Grade:', totalWeightedScore);  // Logging
            }}},
            error: function (xhr, status, error) {
                console.error('Error updating score:', error);  // Logging
                alert("Error updating score. See console for details.");
            }
        });
    });
    
    $('#totalScoreQuarterly[contenteditable="true"]').blur(function () {
        // Get the updated score, column index, and section identifier
        var newScore = $(this).text();
        if (newScore.trim() === '') {
        return;  // Do not update if the input is empty
        }
        var sectionId = 'quarterly_assessment';
        var classRecordId = $('input[name="class_record_id"]').val();
        var columnIndex = $(this).index() -2 ;  // Section identifier for quarterly assessment

        // Get the row, student name, and the corresponding cells
        var row = $(this).closest('tr');
        var totalScoreCell = $(this);
        var percentageScoreCell = row.find('td[id^="percentage_score_quarterly_assessment"]');
        var weightedScoreCell = row.find('td[id^="weighted_score_quarterly_assessment"]');

        // Get the total_max_quarterly and quarterly_assessment_weight from the DOM
        var totalMaxQuarterly = parseFloat($('#total_max_quarterly').text());
        var quarterlyAssessmentWeight = parseFloat($('#quarterly_assessment_weight').text());

        // Calculate the percentage score and weighted score
        var percentageQuarterly = (parseFloat(newScore) / totalMaxQuarterly) * 100;
        var weightedScoreQuarterly = (percentageQuarterly / 100) * quarterlyAssessmentWeight;

        // Update the cells with the calculated values
        percentageScoreCell.text(percentageQuarterly.toFixed(2));
        weightedScoreCell.text(weightedScoreQuarterly.toFixed(2));

        // Send an AJAX request to update the score
        $.ajax({
            type: "POST",
            url: "/update_score/",
            data: {
                'class_record_id': classRecordId,
                'student_name': row.find('td:eq(1)').text(),
                'column_index': columnIndex,
                'new_score': newScore,
                'section_id': sectionId,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (data) {

                  if (data.success === false) {
                    alert(data.error);

                    // Get the section ID dynamically based on the active section
                    var sectionId = $('.tab-pane.active').attr('id');

                    // If the sectionId is undefined, you may need to adjust this based on your HTML structure
                    if (!sectionId) {
                        console.error('Unable to determine the active section ID.');
                        return;
                    }

                    // Store the section ID in local storage
                    localStorage.setItem('activeSection', sectionId);

                    // Reload the page with the fragment identifier
                    location.reload(true);
                } else {
                // Update the total score cell with the returned value from the server
                totalScoreCell.text(data.total_score);

                // Calculate and update the total initial grade
                var updatedWeightedScoreWritten = parseFloat($('#weighted_score_max_written_works').text()) || 0;
                var updatedWeightedScorePerformance = parseFloat($('#weighted_score_performance_task').text()) || 0;
                var updatedWeightedScoreQuarterly = parseFloat($('#weighted_score_quarterly_assessment').text()) || 0;

                var totalWeightedScore = updatedWeightedScoreWritten + updatedWeightedScorePerformance + updatedWeightedScoreQuarterly;
                $('#total_initial_grade').text(totalWeightedScore.toFixed(2));

                console.log('Update Score Success:', data);
                console.log('Initial Grade:', totalWeightedScore);  // Logging
            }},
            error: function (xhr, status, error) {
                console.error('Error updating score:', error);  // Logging
                alert("Error updating score. See console for details.");
            }
        });
    });
    
       
    
        // Add an event listener for the contenteditable cells in the highest possible scores row
        $('.highest-possible-scores[contenteditable="true"]').on('input', function ()  {
            console.log('Blur event triggered for scores.');
            console.log('Class Record ID:', $('input[name="class_record_id"]').val());
            console.log('Section ID:', $(this).closest('.tab-pane').attr('id'));
            
    
            updateTotalMaxWrittenWorks();
            updateTotalMaxPerformance();
            // updateTotalQuarterly();
            // Get the updated scores data


            var newScoresData = [];
            $(this).parent().find('.highest-possible-scores[contenteditable="true"]').each(function () {
                newScoresData.push($(this).text());
            });

            var classRecordId = $('input[name="class_record_id"]').val();
            var sectionId = $(this).closest('.tab-pane').attr('id');
            
    
            console.log('New Scores Data:', newScoresData);
            // Send an AJAX request to update the scores
            $.ajax({
                type: "POST",
                url: "/update_highest_possible_scores/",
                data: {
                    'class_record_id': classRecordId,
                    'section_id': sectionId,
                    'new_hps_data': newScoresData,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function (data) {
                    if (columnIndex >= 0 && columnIndex <= 9) {
                        totalScoreCell.text(data.total_score);
                        percentageScoreCell.text(data.percentage_score);
                        weightedScoreCell.text(data.weighted_score);
    
    
                        // Update the total max values on the client side
                        $('#total_max_written_works').text(data.total_ww_hps.toFixed(2));
                        $('#total_max_performance_task').text(data.total_pt_hps.toFixed(2));
                        // $('#total_max_quarterly').text(data.total_qa_hps.toFixed(2));
                    }
    
    
                    console.log('Update Score Success:', data);  
                },
                error: function () {
                    console.error("Error updating scores.");
                    alert("Error updating score. See console for details.");
                }
            });
        });
    });
    $(document).ready(function () {
    // Add an event listener for the contenteditable change in #total_max_quarterly
    $('#total_max_quarterly').on('input', function () {
        // Get the new value from the contenteditable element
        var newScore = $(this).text().trim();
        var classRecordId = $('input[name="class_record_id"]').val();

        // Make an AJAX request to update the score
        $.ajax({
            type: 'POST',
            url: '/update_total_max_quarterly/',  // Adjust the URL to match your actual endpoint
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            data: {
                'class_record_id': classRecordId,
                'new_score': newScore,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                // Add other necessary data here like student_name, section_id, etc.
            },
            success: function (data) {
                    if (columnIndex >= 0 && columnIndex <= 9) {
                        totalScoreCell.text(data.total_score);
                        percentageScoreCell.text(data.percentage_score);
                        weightedScoreCell.text(data.weighted_score);
    
    
                        // Update the total max values on the client side
                      
                        $('#total_max_quarterly').text(data.total_qa_hps.toFixed(2));
                    }
    
    
                    console.log('Update Score Success:', data);  
                },
            error: function (error) {
                console.log('Error updating score:', error);
                // Handle errors if needed
            }
        });
    });
});
    </script>

    
    
    
{% endblock main_content %}