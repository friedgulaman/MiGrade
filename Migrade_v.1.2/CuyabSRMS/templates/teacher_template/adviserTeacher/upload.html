{% extends 'teacher_template/adviserTeacher/adviser_teacher_base.html' %}
{% block title %}
New Class List
{% endblock title %}
{% block main_content %}
<style>
  .center-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    filter: opacity(0.4);
  }
  .thead{
    background: rgb(232, 232, 232);
  }
  .select_grade_section{
  font-size: 14px;
  text-decoration: none;
  cursor: pointer;
  }
  .back-button{
  color: #1027ac;
  font-size: 25px;
  padding: -2px;
  margin-top: -12px;
  text-decoration: none;
  cursor: pointer;
}
#loading-spinner {
  display: none;
}

</style>
<section class="content container mt-2">
  
  <div class="card p-5 text-center">
    <div class="d-flex justify-content-between align-items-center">
      <a class="back-button">&larr;</a>
      <a class="help-toggle" title="Please go to your Google Sheets account, open the file, copy the URL, and paste it here."><i class="fas fa-question-circle"></i></a>
    </div>
    <h4>Upload SF1 Data</h4>
    <p>Please paste the Google Sheet link containing your SF1 data below:</p>
    <form method="post" action="{% url 'upload' %}" class="container text-center d-flex flex-column">
      {% csrf_token %}
      <input type="text" class="form-control" name="google_sheet_link" id="google_sheet_link" placeholder="Paste Here" required>
      <button type="submit" id="upload_btn" class="btn btn-primary mt-3 container d-flex justify-content-center align-center">Upload</button>
  </form>
  
  {% if messages %}
  <div class="container text-center mt-3">
      {% for message in messages %}
      <div class="alert alert-danger" role="alert">
          {{ message }}
      </div>
      {% endfor %}
  </div>
  {% endif %}
  
  </div>
  <div id="excel-data-container">
    {% csrf_token %}
    <hr>
    <div class="table-responsive mt-3">
      {% if lrn_data %}
      <table class="table table-hover" id="data-table">
        <thead class="thead">
          <tr>
            <th>LRN</th>
            <th>Name</th>
            <th>Sex</th>
            <th>Birthday</th>
            <th>
             <a class="select_grade_section text-danger" id="selectGradeSectionButton">Select Grade and
              Section</a>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for key, values in lrn_data.items %}
          <tr>
            <td>{{ key }}</td>
            <td>{{ values.0.1 }}</td>
            <td>{{ values.0.2 }}</td>
            <td>{{ values.0.3 }}</td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

     
      <div class="modal" id="gradeSectionModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Select Grade and Section</h5>
              <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
              
            </div>
            <div class="modal-body">
              <form id="gradeSectionForm" method="get" action="{% url 'get_grades_and_sections' %}">
                {% csrf_token %}
                <div class="form-group">
                  <label for="grade">Grade</label>
                  <select class="form-control" id="grade" name="grade">
                    <!-- Populate grade options dynamically from the database -->
                    {% for grade in grades %}
                    <option value="{{ grade.name }}">{{ grade.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="section">Section</label>
                  <select class="form-control" id="section" name="section">
                    <!-- Populate section options dynamically from the database -->
                    {% for section in sections %}
                    <option value="{{ section.name }}">{{ section.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="button" class="btn btn-primary" id="saveGradeSection">Save</button>
              </form>
            </div>
          </div>
        </div>
      </div>


{% endif %}





</section>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Wait for the document to be ready
  $(document).ready(function() {
    // Select the Grade select element
    var $gradeSelect = $('#grade');

    // Select the Section select element
    var $sectionSelect = $('#section');

    // Define a function to populate the Section options
    function populateSections(gradeId) {
      // Clear existing options
      $sectionSelect.empty();

      // Make an AJAX request to fetch the sections based on the selected grade
      $.ajax({
        url: '/get_sections/',  // Define the URL to your Django view that returns section options
        data: { grade_id: gradeId },
        method: 'GET',
        success: function(data) {
          // Iterate through the sections and add them to the Section select element
          data.sections.forEach(function(section) {
            $sectionSelect.append('<option value="' + section.id + '">' + section.name + '</option>');
          });
        },
        error: function() {
          // Handle errors if necessary
        }
      });
    }

    // Add an event listener to the Grade select element
    $gradeSelect.on('change', function() {
      var selectedGradeId = $(this).val();

      if (selectedGradeId) {
        // Populate the Section select element when a grade is selected
        populateSections(selectedGradeId);
      } else {
        // Clear the Section select element if no grade is selected
        $sectionSelect.empty();
      }
    });
  });
</script>
<script>
  // Function to open the grade and section selection modal
  const selectGradeSectionButton = document.getElementById('selectGradeSectionButton');
  const gradeSectionModal = new bootstrap.Modal(document.getElementById('gradeSectionModal'));

  if (selectGradeSectionButton && gradeSectionModal) {
    selectGradeSectionButton.addEventListener('click', () => {
      fetchGradesAndSections(); // Fetch grades and sections when the button is clicked
      gradeSectionModal.show();
    });
  }

  // Function to handle the form submission in the modal
  const saveGradeSectionButton = document.getElementById('saveGradeSection');
  if (saveGradeSectionButton) {
    saveGradeSectionButton.addEventListener('click', () => {
      const selectedGrade = document.getElementById('grade').value;
      const selectedSection = document.getElementById('section').value;

      // Get the existing JSON data
      const jsonData = tableToJson();
      console.log(jsonData);

      // Add selectedGrade and selectedSection names to the JSON data
      jsonData.selectedGrade = getSelectedGradeName(selectedGrade);
      jsonData.selectedSection = getSelectedSectionName(selectedSection);

      // Close the modal
      gradeSectionModal.hide();

      // Now, jsonData contains selectedGrade and selectedSection names
      sendJsonData(jsonData); // Send the JSON data to the server
    });
  }

  // Function to get the name of the selected grade based on its ID
  function getSelectedGradeName(selectedGradeId) {
    const gradeSelect = document.getElementById('grade');
    const selectedGrade = Array.from(gradeSelect.options).find(option => option.value === selectedGradeId);
    return selectedGrade ? selectedGrade.textContent : '';
  }

  // Function to get the name of the selected section based on its ID
  function getSelectedSectionName(selectedSectionId) {
    const sectionSelect = document.getElementById('section');
    const selectedSection = Array.from(sectionSelect.options).find(option => option.value === selectedSectionId);
    return selectedSection ? selectedSection.textContent : '';
  }


  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      var cookies = document.cookie.split(';');
      for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + '=') {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function tableToJson() {
    const table = document.getElementById("data-table");
    const data = { rows: [] };

    const rows = table.querySelectorAll("tbody tr");

    rows.forEach(row => {
      const rowData = {};
      const cells = row.querySelectorAll("td");

      // Assuming the first cell is the key (LRN) and the rest are values
      rowData.LRN = cells[0].textContent;
      rowData.Name = cells[1].textContent;
      rowData.Sex = cells[2].textContent;
      rowData.Birthday = cells[3].textContent;

      data.rows.push(rowData);
    });

    return data;
  }

  // Function to send JSON data to your Django views
  function sendJsonData(jsonData) {
    fetch("{% url 'save_json_data' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken') // Include CSRF token
      },
      body: JSON.stringify(jsonData)
    })
      .then(response => response.json())
      .then(data => {
        // Handle the response from the server, e.g., display a success message or perform other actions.
        alert("JSON data has been saved!"); // Add an alert
      })
      .catch(error => {
        // Handle errors, e.g., display an error message to the user.
        alert("An error occurred while saving JSON data: " + error.message); // Add an alert for errors
      });
  }

  // Function to fetch grades and sections
  function fetchGradesAndSections() {
    fetch("{% url 'get_grades_and_sections' %}")
      .then(response => response.json())
      .then(data => {
        const gradeSelect = document.getElementById('grade');
        const sectionSelect = document.getElementById('section');

        // Populate grade options
        data.grades.forEach(grade => {
          const option = document.createElement('option');
          option.value = grade.id;
          option.textContent = grade.name;
          gradeSelect.appendChild(option);
        });

        // Populate section options
        data.sections.forEach(section => {
          const option = document.createElement('option');
          option.value = section.id;
          option.textContent = section.name;
          sectionSelect.appendChild(option);
        });
      })
      .catch(error => {
        console.error("Error fetching grades and sections:", error);
      });
  }

</script>
<script>
  // JavaScript to handle the back button click event
  document.querySelector(".back-button").addEventListener("click", function() {
    window.history.back();
  });
  
</script>

{% endblock main_content %}